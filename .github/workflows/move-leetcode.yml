name: Move LeetCode Solutions

on:
  workflow_dispatch:
  push:
    paths:
      - '[0-9][0-9][0-9][0-9]-*/**'

permissions:
  contents: write

jobs:
  move-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install rsync (for robust directory merging)
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Merge and Clean LeetCode solutions
        id: move
        run: |
          TARGET_PATH="src/main/java/com/codingTest/leetcode"
          
          # 목표 디렉토리가 없다면 생성
          mkdir -p "$TARGET_PATH"
          echo "Target directory created: $TARGET_PATH"
          
          found_move=0
          
          # LeetHub가 생성한 폴더들을 순회합니다. (예: 0058-length-of-last-word)
          for d in [0-9][0-9][0-9][0-9]-*; do
            if [ -d "$d" ]; then
          
              NEW_NAME="${d#*-}" 
              DEST_DIR="$TARGET_PATH/$NEW_NAME"
          
              echo "Processing source directory: $d"
              echo "Calculated destination directory name: $NEW_NAME"
          
              if [ -d "$DEST_DIR" ]; then
                # --- [핵심 로직: 병합 및 덮어쓰기] ---
                echo "Merging contents of $d into existing directory $DEST_DIR"
          
                # rsync를 사용하여 원본 디렉토리의 모든 내용물(d/)을 대상 디렉토리(DEST_DIR/)로 복사 (덮어쓰기 포함)
                # -a: 아카이브 모드 (권한, 타임스탬프 등 유지)
                # -v: 자세한 출력
                rsync -av "$d/" "$DEST_DIR/"
          
                # 병합 후, 원본 디렉토리 삭제
                rm -rf "$d"
                echo "Source directory $d removed after merge."
                # ------------------------------------
              else
                # --- [단순 이동] ---
                echo "Moving directory: $d to $TARGET_PATH/"
                mv "$d" "$TARGET_PATH/"
                # -----------------
              fi
          
              found_move=1
            fi
          done
          
          if [ $found_move -eq 0 ]; then
            echo "No matching directories found to move."
          fi
          
          echo "needs_commit=$found_move" >> $GITHUB_OUTPUT

      - name: Commit & Push changes
        if: steps.move.outputs.needs_commit == '1'
        run: |
          git add -A
          git commit -m "chore: Organize LeetCode solutions (Automated Merge/Move)"
          # 이전의 non-fast-forward 오류 해결을 위해 --force 사용
          git push --force